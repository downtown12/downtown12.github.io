<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>The Encoding Problem in Python 2</title>
	<meta name="description" content="">
	<meta name="generator" content="Hugo 0.40.2" />
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<script type="text/javascript" src="/js/scripts.js"></script>
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container-outer">
		<header class="header">
			<div class="container container-inner">
				<div class="logo" role="banner">
					<a class="logo__link" href="/" title="FgetDaPain" rel="home">
						<div class="logo__title">FgetDaPain</div>
						<div class="logo__tagline">技术与生活</div>
					</a>
				</div>
			</div>
			<div class="divider"></div>
		</header>
		<div class="wrapper flex">

<main class="main content">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">The Encoding Problem in Python 2</h1><div class="post__meta meta">
<svg class="icon icon-time" width="16" height="14" viewBox="0 0 16 16"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"/></svg>
<time class="post__meta-date meta-date" datetime="2018-08-06T23:15:46">August 06, 2018</time>
<span class="post__meta-categories meta-categories">
	<svg class="icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta-categories__list"><a class="meta-categories__link" href="/categories/%e5%bc%80%e5%8f%91" rel="category">开发</a></span>
</span></div>
		</header>
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
<ul>
<li><a href="#python-2神坑之字符编码">Python 2神坑之字符编码</a>
<ul>
<li><a href="#先来说一下python-2-的编码坑">先来说一下Python 2 的编码坑</a></li>
<li><a href="#我最近遇到的编码错误场景">我最近遇到的编码错误场景</a></li>
<li><a href="#如何避免">如何避免</a></li>
</ul></li>
</ul>
</nav>
	</div>
</div>
<div class="post__content clearfix">
			

<h1 id="python-2神坑之字符编码">Python 2神坑之字符编码</h1>

<h2 id="先来说一下python-2-的编码坑">先来说一下Python 2 的编码坑</h2>

<p>我们在写python代码时经常会遇到下边这两种报错：UnicodeDecodeError 和 UnicodeEncodeError：</p>

<p><strong>UnicodeDecodeError</strong>: &lsquo;ascii&rsquo; codec can&rsquo;t decode byte 0x87 in position 0: ordinal not in range(128)</p>

<p><strong>UnicodeEncodeError</strong>: &lsquo;ascii&rsquo; codec can&rsquo;t encode character u&rsquo;\u5728&rsquo; in position 1</p>

<p>这两种报错（异常）的产生都是因为Python 2 中的编码坑：</p>

<p>Python 2中有两种类型的字符串，str和unicode。</p>

<p>当执行一些操作，例如字符串合并（<code>str1 += str2</code>）、join函数（<code>&quot;&quot;.join([str1, str2])</code>）时，如果操作的参数str1和str2一种是str型，而另一种是unicode型的话，Python 2 就会把操作的结果进行类型转化（通常是将结果统一成unicode类型）。而这个编码转化是Python自动帮你做的。举个例子：</p>

<pre><code class="language-python">	In [6]: str1 = &quot;fgetdapain&quot;

	In [7]: str2 = u&quot;is a nickname&quot;

	In [8]: str1 + str2

	Out[8]: u'fgetdapainis a nickname'

	In [9]: &quot;&quot;.join([str1, str2])

	Out[9]: u'fgetdapainis a nickname'

</code></pre>

<p>可以看到，str1是一个str型字符串，而str2是一个unicode型的字符串，在<code>+</code>和<code>join</code>两个操作后，操作的结果都变成了unicode类型。</p>

<p>然而，当str1或str2中有一些特殊字符的时候，例如str1和str2中的一个是从二进制文件中读取内容（例如从文件中读到一个字符：<code>'\x87'</code>，这个字符在Unicode字符集中就不存在），这时如果做转换就会出错：</p>

<pre><code class="language-python">In [11]: str1 = &quot;read from file: \x87&quot;
In [12]: str2 = u&quot;normal unicode string&quot;
In [13]: str1 + str2
---------------------------------------------------------------
UnicodeDecodeError                        Traceback (most recent call last)
&lt;ipython-input-13-01bd5b4ad288&gt; in &lt;module&gt;()
----&gt; 1 str1 + str2

UnicodeDecodeError: 'ascii' codec can't decode byte 0x87 in position 16: ordinal not in range(128)
</code></pre>

<p>然而，我们在写代码时，<strong><em>这种字符串间的操作无处不在，稍有不慎，程序就回报出上述错误</em></strong>。即使自己做好了统一字符串的类型，但是有可能用到了外部库，引用了库中的模块代码，还是有可能出现编码上的错误。</p>

<h2 id="我最近遇到的编码错误场景">我最近遇到的编码错误场景</h2>

<p>例如，我最近在用<code>httplib</code>这个Python标准库写一个自动POST文件到目标服务器的功能时，就遇到了编码问题。这里值得提一句，目标服务器接受的POST表单是multipart格式的。</p>

<p>在实现这个功能时，首先我按照服务器接受的参数和格式要求准备好了POST请求，并确保把它封装进字符串（这时我没有留意字符串的类型）。然后调用<code>httplib.HTTPConnection</code>类中的<code>request</code>方法去给服务器POST数据，而这个<code>request</code>方法的实现代码中，就有不少字符串操作，而这之中就会出现字符串类型的转换。</p>

<p>举个例子，下面这段代码是一段httplib的源码，调用<code>httplib.HTTPConnection</code>类的<code>request</code>方法就会调用此函数。<code>_send_output</code>函数的作用是将HTTP Header（Header存放在<code>self._buffer</code>）与HTTP Body拼装好，然后将整个请求发送出去。</p>

<pre><code class="language-python"> def _send_output(self, message_body=None):
        &quot;&quot;&quot;Send the currently buffered request and clear the buffer.

        Appends an extra \\r\\n to the buffer.
        A message_body may be specified, to be appended to the request.
        &quot;&quot;&quot;
        self._buffer.extend((&quot;&quot;, &quot;&quot;))
        msg = &quot;\r\n&quot;.join(self._buffer)
        del self._buffer[:]
        # If msg and message_body are sent in a single send() call,
        # it will avoid performance problems caused by the interaction
        # between delayed ack and the Nagle algorithm.
        if isinstance(message_body, str):
            msg += message_body	#这里对msg做了+操作
            message_body = None
        self.send(msg)
        if message_body is not None:
            #message_body was not a string (i.e. it is a file) and
            #we must run the risk of Nagle
            self.send(message_body)
</code></pre>

<p>上边这个函数就很容易出现编码问题，假设我们传入的URL参数是一个unicode型字符串，例如是<code>url = u&quot;http://blog.wangjiteng.club/somepath&quot;</code>。用这个url拼装头部的时候，就会让整个头部字符串的类型是unicode型，然后，我们给HTTP Body传入一个str型的字符串，例如是向目标URL所POST的文件内容，文件中有一些二进制数据。</p>

<p>这时，在调用httplib发送请求时，执行到上边函数的<code>msg += message_body</code>一句，就回报错。这是由于头部信息<code>msg</code>是unicode型，而Body信息<code>message_body</code>是str型。执行这句代码时，会尝试将str型<code>message_body</code>转换为unicode型。但<code>message_body</code>中有二进制字节（例如<code>'\x87'</code>），unicode无法解析这种字节，就回抛出异常：</p>

<pre><code class="language-python">UnicodeDecodeError: 'ascii' codec can't decode byte 0x87 in position 0: ordinal not in range(128)
</code></pre>

<h2 id="如何避免">如何避免</h2>

<p>上面提到了，我在准备HTTP请求数据时，没有检查好所有数据字符串的类型，URL是unicode型，而请求体Body是str型，因此引发了这个编码错误。</p>

<p><strong>为了避免类似问题发生，我们在Python 2环境下使用字符串时，要尽量做到字符串类型的统一。或者对字符串做显示转换，避免上述隐式转换的发生。</strong></p>

<p>在写HTTP请求时，会处理很多用户传入的字符串，其中包括：url字符串，cookies类型，其他headers，body&hellip; 我们把这些字符串组合成HTTP请求，然后调用一些库，如: httplib, urllib, requests，来发送这些请求。</p>

<p>这些HTTP库的作者大多为老外，他们在写库的时候多用str类型来做字符串操作（例如httplib就是），因此在进行网络编程时，就要尽量避免编码问题。</p>

<p>总之，为了避免类似错误再次发生，我总结要注意以下几点：</p>

<ol>
<li>调用第三方的库时，要检查好传参时参数的字符串类型。确保类型统一，且与第三方库统一。</li>
<li>在做网络编程、文件传送、解析二进制时，最好使用str类型来操作字符。因为如果用unicode会有一些二进制字符无法解码。</li>
<li>自己写代码时，按照以下原则做好字符串类型的统一：

<ul>
<li>做文本处理（如查找字符串中文字个数、切分字符串）时，统一用unicode型的字符串</li>
<li>做 I/O处理（如，读写磁盘上的文件，打印一个字符串，网络通信等）时，使用str类型的字符串</li>
</ul></li>
</ol>

		</div>
		
<div class="post__tags tags clearfix">
	<svg class="icon icon-tag" width="16" height="16" viewBox="0 0 16 16"><path d="M16 9.5c0 .373-.24.74-.5 1l-5 5c-.275.26-.634.5-1 .5-.373 0-.74-.24-1-.5L1 8a2.853 2.853 0 0 1-.7-1C.113 6.55 0 5.973 0 5.6V1.4C0 1.034.134.669.401.401.67.134 1.034 0 1.4 0h4.2c.373 0 .95.113 1.4.3.45.187.732.432 1 .7l7.5 7.502c.26.274.5.632.5.998zM3.5 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/python/" rel="tag">Python</a></li>
	</ul>
</div>
	</article>
	
<div class="authorbox clearfix">
	<div class="authorbox__header">
		<span class="authorbox__name">About FgetDaPain</span>
	</div>
	<div class="authorbox__description">
		A Pythoner, Penetration Tester. 一个热爱学习的人.
	</div>
</div>
	
<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/post/information-gathering-during-penetration-testing-targeting-an-internal-system/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">随笔: 一次渗透演习过程中的信息收集工作</p></a>
	</div>
</nav>
	
</main>


<aside class="sidebar">
	
<div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="https://google.com/search">
		<label>
			<input class="widget-search__field" type="search" placeholder="SEARCH..." value="" name="q">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="/" />
	</form>
</div>
	
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/post/encoding-problem-in-python-2/">The Encoding Problem in Python 2</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/information-gathering-during-penetration-testing-targeting-an-internal-system/">随笔: 一次渗透演习过程中的信息收集工作</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/management-of-vulnerability-lifetime-in-a-bank/">银行业的漏洞生命周期管理流程</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/first-exploration-of-celery-and-message-queue/">初探：Python Celery任务调度模块和消息队列</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/how-to-build-this-personal-blog-using-hugo/">我是如何用Hugo搭建这个个人博客的</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/categories/%e5%ae%89%e5%85%a8">安全</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/%e5%bc%80%e5%8f%91">开发</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/%e6%8a%80%e6%9c%af">技术</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/downtown12" target="_blank">
				<svg class="widget-social__link-icon icon-github" viewBox="0 0 384 374" width="24" height="24" fill="#fff"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Email" href="mailto:imwjt@163.com">
				<svg class="widget-social__link-icon icon-mail" viewBox="0 0 416 288" width="24" height="24" fill="#fff"><path d="m0 16v256 16h16 384 16v-16-256-16h-16-384-16zm347 16-139 92.5-139-92.5zm-148 125.5 9 5.5 9-5.5 167-111.5v210h-352v-210z"/></svg>
				<span>imwjt@163.com</span>
			</a>
		</div>
	</div>
</div>
	
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/hugo" title="Hugo">Hugo</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/mq" title="Mq">Mq</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/python" title="Python">Python</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%e4%bb%bb%e5%8a%a1%e8%b0%83%e5%ba%a6" title="任务调度">任务调度</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%e4%bf%a1%e6%81%af%e6%94%b6%e9%9b%86" title="信息收集">信息收集</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%e5%ae%89%e5%85%a8%e7%ae%a1%e7%90%86" title="安全管理">安全管理</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%e6%b6%88%e6%81%af%e5%af%b9%e5%88%97" title="消息对列">消息对列</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95" title="渗透测试">渗透测试</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%e7%bd%91%e7%ab%99%e8%bf%90%e7%bb%b4" title="网站运维">网站运维</a>
	</div>
</div>
</aside>
	</div>
		<footer class="footer">
			<div class="container container-inner">
				<div class="footer__copyright">&copy; 2018 FgetDaPain. <span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span></div>
			</div>
		</footer>
	</div>

<script>
	var navigation = responsiveNav(".menu", {
		navClass: "menu--collapse",
	});
</script></body>
</html>